<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>GeoIPT - Mapa de consulta Instrumentos de Planificación Territorial</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
      Roboto, Helvetica, Arial, sans-serif;
      background: #0b1120;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #020617;
      border-bottom: 1px solid #111827;
      padding: 8px 16px;
    }

    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .brand { display: flex; flex-direction: column; gap: 0.15rem; }
    .brand-title { font-size: 1.1rem; font-weight: 600; }
    .brand-subtitle { font-size: 0.78rem; color: #9ca3af; }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      min-width: 180px;
      font-size: 0.8rem;
    }

    .control-group label {
      color: #9ca3af;
    }

    select {
      background: #020617;
      border-radius: 999px;
      border: 1px solid #1f2937;
      color: #e5e7eb;
      padding: 0.3rem 0.75rem;
      font-size: 0.85rem;
      outline: none;
    }

    main {
      flex: 1;
      position: relative;
    }

    .map-container {
      max-width: 1200px;
      margin: 10px auto 16px;
      position: relative;
    }

    #map {
      width: 100%;
      height: 520px;        /* fijo para evitar mapa negro */
      min-height: 520px;
      border-radius: 1rem;
      border: 1px solid #1f2937;
    }

    .hint {
      margin-top: 6px;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    /* Botón mira de rifle */
    #mira-rifle {
      position: absolute;
      bottom: 25px;
      right: 25px;
      z-index: 5000;
      width: 46px;
      height: 46px;
      background: #ffffffee;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      border: 1px solid #d1d5db;
      backdrop-filter: blur(6px);
    }

    #mira-rifle::before {
      content: "";
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid #111827;
      box-shadow: 0 0 0 1px #111827;
    }
    #mira-rifle::after {
      content: "";
      position: absolute;
      width: 2px;
      height: 18px;
      background: #111827;
    }
  </style>
</head>

<body>
  <header>
    <div class="header-inner">
      <div class="brand">
        <div class="brand-title">GeoIPT</div>
        <div class="brand-subtitle">
          Consulta rápida de instrumentos de planificación territorial (PRC / SCC)
        </div>
      </div>

      <div class="controls">
        <div class="control-group">
          <label for="region-select">Región</label>
          <select id="region-select"></select>
        </div>

        <div class="control-group">
          <label for="instrumento-select">Instrumento (zoom óptico)</label>
          <select id="instrumento-select" disabled>
            <option value="">Selecciona un instrumento para hacer zoom</option>
          </select>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="map-container">
      <div id="map"></div>
      <p class="hint">
        <strong>Instrucciones:</strong>
        Selecciona región e instrumento para ubicarte. Luego haz clic en el mapa
        para abrir el <strong>motor BBOX</strong> (bbox_test.html) con el punto consultado y el área visible;
        allí se determinarán los IPT.kml a explorar y se generará el reporte en info.html.
      </p>

      <div id="mira-rifle" title="Ir a mi ubicación"></div>
    </div>
  </main>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    const regionSelect = document.getElementById("region-select");
    const instrumentoSelect = document.getElementById("instrumento-select");
    let regionesData = [];
    let map;
    let marcadorPunto = null;

    // -------------------------
    // Utilidad: leer lat/lon si vienen por URL
    // -------------------------
    function getUrlParamsLatLon() {
      const p = new URLSearchParams(window.location.search);
      const lat = parseFloat(p.get("lat"));
      const lon = parseFloat(p.get("lon"));
      if (Number.isNaN(lat) || Number.isNaN(lon)) {
        return null;
      }
      return { lat, lon };
    }

    // -------------------------
    // MAPA BASE
    // -------------------------
    function initMapa() {
      const mapaCalle = L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap contributors",
        }
      );

      const mapaSatelite = L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        {
          maxZoom: 19,
          attribution:
            "Tiles © Esri — Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP",
        }
      );

      map = L.map("map", {
        center: [-27.5, -70.25],
        zoom: 5,
        minZoom: 4,
        maxZoom: 19,
        layers: [mapaCalle],     // OSM simple por defecto
      });

      L.control
        .layers(
          {
            "Mapa calle": mapaCalle,
            "Satélite": mapaSatelite,
          },
          {},
          { position: "topright" }
        )
        .addTo(map);

      // Si viene llamado desde info.html con lat/lon: centrar ahí
      const p = getUrlParamsLatLon();
      if (p) {
        const { lat, lon } = p;
        map.setView([lat, lon], 16);
        marcadorPunto = L.circleMarker([lat, lon], {
          radius: 6,
          color: "#f97316",
          weight: 2,
          fillColor: "#ffffff",
          fillOpacity: 0.9
        }).addTo(map);
      }

      // CLICK → motor BBOX (bbox_test.html) con lat, lon y BBOX (north,east,south,west)
      map.on("click", (e) => {
        const lat = e.latlng.lat;
        const lon = e.latlng.lng;

        // actualizar / crear marcador
        if (marcadorPunto) {
          marcadorPunto.setLatLng(e.latlng);
        } else {
          marcadorPunto = L.circleMarker(e.latlng, {
            radius: 6,
            color: "#f97316",
            weight: 2,
            fillColor: "#ffffff",
            fillOpacity: 0.9
          }).addTo(map);
        }

        const bounds = map.getBounds();
        const north = bounds.getNorth();
        const east  = bounds.getEast();
        const south = bounds.getSouth();
        const west  = bounds.getWest();

        const bboxStr = [
          north.toFixed(8),
          east.toFixed(8),
          south.toFixed(8),
          west.toFixed(8)
        ].join(",");

        const url = new URL("bbox_test.html", window.location.href);
        url.searchParams.set("lat", lat.toFixed(6));
        url.searchParams.set("lon", lon.toFixed(6));
        url.searchParams.set("bbox", bboxStr);

        // IMPORTANTE: solo enviamos lat, lon, bbox (sin región)
        window.open(url, "_blank");
      });

      // Mira de rifle (geolocalización)
      const mira = document.getElementById("mira-rifle");
      if (mira) {
        mira.addEventListener("click", () => {
          if (!navigator.geolocation) {
            alert("Tu navegador no soporta geolocalización.");
            return;
          }

          navigator.geolocation.getCurrentPosition(
            (pos) => {
              map.setView([pos.coords.latitude, pos.coords.longitude], 16);
            },
            (err) => {
              console.error(err);
              alert("No se pudo obtener tu ubicación.");
            },
            { enableHighAccuracy: true, timeout: 10000 }
          );
        });
      }
    }

    // -------------------------
    // REGIONES
    // -------------------------
    async function cargarRegiones() {
      try {
        const resp = await fetch("capas/regiones.json");
        if (!resp.ok) throw new Error("No se pudo leer capas/regiones.json");

        const data = await resp.json();
        regionesData = Array.isArray(data)
          ? data
          : data.regiones_ipt || data.regiones || [];

        regionSelect.innerHTML = "";

        regionesData
          .filter((r) => r.activo !== false)
          .forEach((r) => {
            const opt = document.createElement("option");
            opt.value = r.codigo_ine;
            const nombreCorto = (r.nombre || "").replace(/^Región( de)? /i, "");
            opt.textContent = `${r.codigo_ine} - ${nombreCorto}`;
            regionSelect.appendChild(opt);
          });

        let defaultCode = "03"; // Atacama como default
        if (!regionesData.some((r) => r.codigo_ine === defaultCode)) {
          defaultCode = regionesData[0]?.codigo_ine;
        }

        if (defaultCode) {
          regionSelect.value = defaultCode;
          centrarEnRegion(defaultCode);
          cargarInstrumentos(defaultCode);
        }
      } catch (err) {
        console.error("Error cargando regiones:", err);
      }
    }

    function obtenerRegionPorCodigo(cod) {
      return regionesData.find((r) => r.codigo_ine === cod) || null;
    }

    function centrarEnRegion(cod) {
      const reg = obtenerRegionPorCodigo(cod);
      if (!reg || !Array.isArray(reg.centro)) return;
      const [lat, lon] = reg.centro;
      const zoom = reg.zoom || 7;
      map.setView([lat, lon], zoom);
    }

    // -------------------------
    // INSTRUMENTOS (zoom óptico)
    // -------------------------
    async function cargarInstrumentos(regionCode) {
      instrumentoSelect.innerHTML = "";
      instrumentoSelect.disabled = true;

      const def = document.createElement("option");
      def.value = "";
      def.textContent = "Selecciona un instrumento para hacer zoom";
      instrumentoSelect.appendChild(def);

      const reg = obtenerRegionPorCodigo(regionCode);
      if (!reg) {
        console.warn("No se encontró la región", regionCode);
        return;
      }

      const carpetaRegion = reg.carpeta; // ej: "capas_03"
      const url = `capas/${carpetaRegion}/listado.json`;

      try {
        const resp = await fetch(url);
        if (!resp.ok) {
          console.warn("No se pudo leer", url, resp.status);
          return;
        }

        const data = await resp.json();
        const lista = data.instrumentos || data.kml || [];

        lista.forEach((entry) => {
          let archivo = "";
          let nombre = "";

          if (typeof entry === "string") {
            archivo = entry;
            nombre = entry.replace(/\.kml$/i, "");
          } else if (entry && typeof entry === "object") {
            archivo = entry.archivo || entry.kml || "";
            nombre = (entry.nombre || archivo || "").replace(/\.kml$/i, "");
          }

          if (!archivo) return;

          const opt = document.createElement("option");
          opt.value = archivo;
          opt.textContent = nombre;
          instrumentoSelect.appendChild(opt);
        });

        instrumentoSelect.disabled = instrumentoSelect.options.length <= 1;
      } catch (e) {
        console.error("Error leyendo instrumentos:", e);
      }
    }

    async function zoomAlInstrumento(regionCode, archivo) {
      if (!archivo) return;

      const reg = obtenerRegionPorCodigo(regionCode);
      if (!reg) return;

      const carpetaRegion = reg.carpeta;
      const url = `capas/${carpetaRegion}/${archivo}`;

      try {
        const resp = await fetch(url);
        if (!resp.ok) {
          console.warn("No se pudo abrir el KML:", url);
          return;
        }
        const txt = await resp.text();

        const xml = new DOMParser().parseFromString(txt, "application/xml");
        const coords = xml.querySelectorAll("coordinates");

        const puntos = [];
        coords.forEach((c) => {
          c.textContent
            .trim()
            .split(/\s+/)
            .forEach((par) => {
              const [lon, lat] = par.split(",").map(Number);
              if (!isNaN(lat) && !isNaN(lon)) puntos.push([lat, lon]);
            });
        });

        if (puntos.length) {
          map.fitBounds(L.latLngBounds(puntos), { padding: [30, 30] });
        }
      } catch (e) {
        console.warn("No se pudo procesar el KML:", e);
      }
    }

    // -------------------------
    // INICIO
    // -------------------------
    document.addEventListener("DOMContentLoaded", () => {
      initMapa();
      cargarRegiones();

      regionSelect.addEventListener("change", () => {
        const code = regionSelect.value;
        centrarEnRegion(code);
        cargarInstrumentos(code);
      });

      instrumentoSelect.addEventListener("change", () => {
        zoomAlInstrumento(regionSelect.value, instrumentoSelect.value);
      });
    });
  </script>
</body>
</html>
