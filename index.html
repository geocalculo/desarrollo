map.on("click", (e) => {
  selectedLat = e.latlng.lat;
  selectedLon = e.latlng.lng;

  if (marker) {
    marker.setLatLng(e.latlng);
  } else {
    marker = L.marker(e.latlng).addTo(map);
  }

  latSpan.textContent = "Lat: " + selectedLat.toFixed(6);
  lonSpan.textContent = "Lon: " + selectedLon.toFixed(6);

  const region = regionSelect.value || "";
  const instrumento = instrumentSelect.value || "";

  if (!instrumento) {
    estadoTexto.textContent =
      "Debe seleccionar un instrumento antes de hacer clic en el mapa.";
    return;
  }

  const params = new URLSearchParams({
    lat: selectedLat,
    lon: selectedLon,
    region: region,
    instrumento: instrumento
  });

  window.open("info.html?" + params.toString(), "_blank");
});
