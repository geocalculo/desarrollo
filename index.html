<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>GeoIPT - Mapa de consulta Instrumentos PRC / SCC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, Helvetica, Arial, sans-serif;
      background: #020617;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #020617;
      border-bottom: 1px solid #111827;
      padding: 8px 16px;
    }

    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .brand {
      display: flex;
      flex-direction: column;
    }

    .brand-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .brand-subtitle {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      font-size: 0.85rem;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .control-group label {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    select {
      min-width: 190px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.85rem;
    }

    main {
      flex: 1;
      display: flex;
      justify-content: center;
      padding: 12px 8px 16px;
    }

    .layout {
      width: 1200px;
      max-width: 100%;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #mapaGeoipt {
      width: 100%;
      height: calc(100vh - 150px);
      min-height: 420px;
      border-radius: 12px;
      border: 1px solid #111827;
      overflow: hidden;
    }

    .footer-panel {
      font-size: 0.78rem;
      color: #9ca3af;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .footer-panel strong {
      color: #e5e7eb;
    }

    #listaInstrumentos {
      background: #020617;
      border-radius: 10px;
      border: 1px solid #111827;
      padding: 8px 10px;
      max-height: 140px;
      overflow-y: auto;
    }

    #listaInstrumentos ul {
      list-style: disc;
      padding-left: 18px;
      font-size: 0.8rem;
    }

    #listaInstrumentos li {
      margin-bottom: 2px;
    }

    .instr {
      font-size: 0.78rem;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="brand">
        <span class="brand-title">GeoIPT</span>
        <span class="brand-subtitle">
          Consulta rápida de instrumentos de planificación territorial (PRC / SCC)
        </span>
      </div>
      <div class="controls">
        <div class="control-group">
          <label for="regionSelect">Región</label>
          <select id="regionSelect">
            <option value="">(cargando...)</option>
          </select>
        </div>
        <div class="control-group">
          <label for="instrumentoSelect">Instrumento (zoom óptico)</label>
          <select id="instrumentoSelect">
            <option value="">Todos los instrumentos</option>
          </select>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="layout">
      <div id="mapaGeoipt"></div>

      <div class="footer-panel">
        <div>
          <strong>Instrucciones:</strong>
          Selecciona región e instrumento para ubicarte. Luego haz clic en el mapa
          para abrir el <strong>motor BBOX</strong> (bbox_test.html) con el punto consultado
          y el área visible; allí se determinarán los IPT.kml a explorar y
          se generará el reporte en info.html.
        </div>
        <div class="instr">
          <strong>Instrumentos PRC/SCC detectados en el BBOX actual:</strong>
        </div>
        <div id="listaInstrumentos">
          (cargando instrumentos…)
        </div>
      </div>
    </div>
  </main>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    let map;
    let regiones = [];
    let instrumentosNacionales = [];

    const REGION_SELECT_ID = "regionSelect";
    const INSTRUMENTO_SELECT_ID = "instrumentoSelect";
    const LISTA_INSTRUMENTOS_ID = "listaInstrumentos";

    async function cargarJSON(url, descripcion) {
      try {
        const resp = await fetch(url);
        if (!resp.ok) {
          console.error(\`Error al cargar \${descripcion} desde \${url}: \`, resp.status);
          return null;
        }
        return await resp.json();
      } catch (err) {
        console.error(\`Excepción al cargar \${descripcion} desde \${url}: \`, err);
        return null;
      }
    }

    async function initGeoIPT() {
      const mapDiv = document.getElementById("mapaGeoipt");
      if (!mapDiv) {
        console.error("No se encontró el DIV del mapa");
        return;
      }

      map = L.map("mapaGeoipt", {
        center: [-30.5, -71.0],
        zoom: 5,
        minZoom: 4,
        maxZoom: 19
      });

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 20,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      // Cargar regiones
      const regionesData = await cargarJSON("regiones.json", "regiones");
      if (regionesData) {
        regiones = regionesData.regiones_ipt || regionesData.regiones || [];
      }

      // Cargar listado nacional de instrumentos PRC/SCC
      const instrumentosData = await cargarJSON(
        "capas/prc_bbox_nacional.json",
        "listado nacional de instrumentos"
      );
      if (instrumentosData) {
        instrumentosNacionales = instrumentosData.instrumentos || instrumentosData;
      } else {
        instrumentosNacionales = [];
      }

      poblarComboRegiones();
      poblarComboInstrumentosPorRegion(null);
      actualizarListaInstrumentosEnPantalla();

      // Click: envía lat, lon, bbox a bbox_test.html
      map.on("click", function (e) {
        const lat = e.latlng.lat.toFixed(6);
        const lon = e.latlng.lng.toFixed(6);

        const bounds = map.getBounds();
        const north = bounds.getNorth();
        const south = bounds.getSouth();
        const east  = bounds.getEast();
        const west  = bounds.getWest();

        const bboxStr = [north, east, south, west].join(",");

        const url = \`bbox_test.html?lat=\${lat}&lon=\${lon}&bbox=\${encodeURIComponent(bboxStr)}\`;
        window.open(url, "_blank");
      });

      // Cuando se mueve el mapa, actualizamos lista visual de instrumentos
      map.on("moveend", () => {
        actualizarListaInstrumentosEnPantalla();
      });
    }

    function poblarComboRegiones() {
      const regionSelect = document.getElementById(REGION_SELECT_ID);
      if (!regionSelect) return;

      regionSelect.innerHTML = "";

      const optDefault = document.createElement("option");
      optDefault.value = "";
      optDefault.textContent = "Todas las regiones";
      regionSelect.appendChild(optDefault);

      regiones.forEach((reg) => {
        const opt = document.createElement("option");
        opt.value = reg.id || reg.nombre;
        opt.textContent = reg.nombre || reg.id;
        regionSelect.appendChild(opt);
      });

      regionSelect.addEventListener("change", () => {
        const valor = regionSelect.value;
        if (!valor) return;

        const reg = regiones.find(
          (r) => String(r.id) === valor || r.nombre === valor
        );
        if (!reg) return;

        if (reg.centro && reg.zoom) {
          map.setView([reg.centro[0], reg.centro[1]], reg.zoom);
        } else if (reg.bbox && reg.bbox.length === 4) {
          const [minLat, minLon, maxLat, maxLon] = reg.bbox;
          const bounds = L.latLngBounds([minLat, minLon], [maxLat, maxLon]);
          map.fitBounds(bounds);
        }

        poblarComboInstrumentosPorRegion(reg);
        actualizarListaInstrumentosEnPantalla();
      });
    }

    function poblarComboInstrumentosPorRegion(regionObj) {
      const instrumentoSelect = document.getElementById(INSTRUMENTO_SELECT_ID);
      if (!instrumentoSelect) return;

      instrumentoSelect.innerHTML = "";

      const optDefault = document.createElement("option");
      optDefault.value = "";
      optDefault.textContent = "Todos los instrumentos";
      instrumentoSelect.appendChild(optDefault);

      let filtroRegionNombre = null;
      let filtroCarpeta = null;

      if (regionObj) {
        filtroRegionNombre = regionObj.nombre || null;
        filtroCarpeta = regionObj.carpeta || regionObj.id || null;
      }

      const instrumentosFiltrados = instrumentosNacionales.filter((inst) => {
        if (!regionObj) return true;
        if (inst.regionNombre && filtroRegionNombre) {
          return inst.regionNombre === filtroRegionNombre;
        }
        if (inst.regionCarpeta && filtroCarpeta) {
          return inst.regionCarpeta === filtroCarpeta;
        }
        if (inst.carpeta && filtroCarpeta) {
          return inst.carpeta === filtroCarpeta;
        }
        return true;
      });

      instrumentosFiltrados.forEach((inst, idx) => {
        const opt = document.createElement("option");
        opt.value = inst.archivo || String(idx);
        opt.textContent = inst.nombre || inst.archivo || \`Instrumento \${idx + 1}\`;
        instrumentoSelect.appendChild(opt);
      });

      instrumentoSelect.addEventListener("change", () => {
        const valor = instrumentoSelect.value;
        if (!valor) return;
        const inst = instrumentosNacionales.find((i) => i.archivo === valor);
        if (inst && Array.isArray(inst.bbox) && inst.bbox.length === 4) {
          const [minLat, minLon, maxLat, maxLon] = inst.bbox;
          const bounds = L.latLngBounds([minLat, minLon], [maxLat, maxLon]);
          map.fitBounds(bounds);
        }
      });
    }

    function filtrarInstrumentosPorBbox(bbox) {
      const { north, east, south, west } = bbox;

      return instrumentosNacionales.filter((inst) => {
        if (!inst.bbox || inst.bbox.length !== 4) return false;
        const [iMinLat, iMinLon, iMaxLat, iMaxLon] = inst.bbox;

        const minLat = south;
        const maxLat = north;
        const minLon = west;
        const maxLon = east;

        const noIntersecta =
          iMaxLat < minLat ||
          iMinLat > maxLat ||
          iMaxLon < minLon ||
          iMinLon > maxLon;

        return !noIntersecta;
      });
    }

    function actualizarListaInstrumentosEnPantalla() {
      const contenedor = document.getElementById(LISTA_INSTRUMENTOS_ID);
      if (!contenedor) return;
      if (!instrumentosNacionales.length || !map) {
        contenedor.textContent = "(sin datos)";
        return;
      }

      const bounds = map.getBounds();
      const bbox = {
        north: bounds.getNorth(),
        east:  bounds.getEast(),
        south: bounds.getSouth(),
        west:  bounds.getWest()
      };

      const enPantalla = filtrarInstrumentosPorBbox(bbox);

      if (!enPantalla.length) {
        contenedor.textContent = "No hay instrumentos PRC/SCC en el área visible.";
        return;
      }

      const ul = document.createElement("ul");
      enPantalla.forEach((inst) => {
        const li = document.createElement("li");
        li.textContent =
          (inst.regionNombre || "") +
          " – " +
          (inst.comuna || "") +
          " – " +
          (inst.nombre || inst.archivo);
        ul.appendChild(li);
      });

      contenedor.innerHTML = "";
      contenedor.appendChild(ul);
    }

    document.addEventListener("DOMContentLoaded", () => {
      initGeoIPT().catch((err) => {
        console.error("Error inicializando GeoIPT:", err);
      });
    });
  </script>
</body>
</html>
