<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>GeoIPT - Mapa de consulta Instrumentos de Planificación Territorial</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, Helvetica, Arial, sans-serif;
      background: #0b1120;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #020617;
      border-bottom: 1px solid #111827;
      padding: 8px 16px;
    }

    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .brand { display: flex; flex-direction: column; gap: 0.15rem; }
    .brand-title { font-size: 1.1rem; font-weight: 600; }
    .brand-subtitle { font-size: 0.78rem; color: #9ca3af; }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      justify-content: flex-end;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      min-width: 180px;
    }

    .control-group label { font-size: 0.75rem; color: #9ca3af; }

    select {
      background: #020617;
      border-radius: 999px;
      border: 1px solid #1f2937;
      color: #e5e7eb;
      padding: 0.3rem 0.75rem;
      font-size: 0.85rem;
      outline: none;
    }

    select:focus { border-color: #3b82f6; }

    main {
      flex: 1;
      display: flex;
      justify-content: center;
      padding: 0.75rem;
    }

    .map-container {
      width: 100%;
      max-width: 1200px;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    #map {
      width: 100%;
      height: calc(100vh - 110px);
      min-height: 420px;
      border-radius: 1rem;
      overflow: hidden;
      border: 1px solid #1f2937;
    }

    .hint { font-size: 0.8rem; color: #9ca3af; }
    .hint strong { color: #e5e7eb; }

    @media (max-width: 640px) {
      header { padding: 8px 10px; }
      #map { height: calc(100vh - 130px); }
      .control-group { min-width: 100%; }
    }

    .leaflet-control-locate {
      width: 34px;
      height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <header>
    <div class="header-inner">
      <div class="brand">
        <div class="brand-title">GeoIPT</div>
        <div class="brand-subtitle">
          Consulta rápida de instrumentos de planificación territorial (PRC / SCC)
        </div>
      </div>

      <div class="controls">
        <div class="control-group">
          <label for="region-select">Región</label>
          <select id="region-select"></select>
        </div>

        <div class="control-group">
          <label for="instrumento-select">Instrumento (zoom óptico)</label>
          <select id="instrumento-select" disabled>
            <option value="">Selecciona un instrumento para hacer zoom</option>
          </select>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="map-container">
      <div id="map"></div>
      <p class="hint">
        <strong>Instrucciones:</strong> Desde el minuto 0 puedes hacer clic en el mapa
        para abrir un reporte detallado del punto en una nueva pestaña.
      </p>
    </div>
  </main>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ---------------------------------
    // MAPA BASE
    // ---------------------------------
    const map = L.map('map', {
      center: [-27.5, -70.5],
      zoom: 7,
      minZoom: 4,
      maxZoom: 19
    });

    const osm = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }
    ).addTo(map);

    const esriSat = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      {
        maxZoom: 19,
        attribution:
          "Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye"
      }
    );

    L.control.layers({ "Mapa calle": osm, "Satélite": esriSat }, {}, { position: "topright" }).addTo(map);

    const regionSelect = document.getElementById("region-select");
    const instrumentoSelect = document.getElementById("instrumento-select");

    // ---------------------------------
    // CARGAR REGIONES DESDE regiones.json
    // ---------------------------------
    async function cargarRegiones() {
      try {
        const resp = await fetch("capas/regiones.json");
        const regiones = await resp.json();

        regionSelect.innerHTML = "";

        regiones
          .filter(r => r.activo)
          .forEach(r => {
            const opt = document.createElement("option");
            opt.value = r.codigo_ine;
            opt.textContent = `${r.codigo_ine} - ${r.nombre.replace("Región de ", "")}`;
            regionSelect.appendChild(opt);
          });

        regionSelect.value = "03"; // Atacama por defecto
      } catch (err) {
        console.error("Error cargando regiones.json", err);
      }
    }

    // ---------------------------------
    // CARGAR INSTRUMENTOS
    // ---------------------------------
    async function cargarInstrumentos(regionCode) {
      instrumentoSelect.innerHTML = "";
      instrumentoSelect.disabled = true;

      const optDefault = document.createElement("option");
      optDefault.value = "";
      optDefault.textContent = "Selecciona un instrumento para hacer zoom";
      instrumentoSelect.appendChild(optDefault);

      if (!regionCode) return;

      const basePath = `capas/capas_${regionCode}/listado.json`;

      try {
        const resp = await fetch(basePath);
        if (!resp.ok) return;

        const listado = await resp.json();
        let entradas = listado.instrumentos || listado.kml || listado || [];

        entradas.forEach(e => {
          const archivo = e.archivo || e;
          const nombre = e.nombre || archivo;

          const opt = document.createElement("option");
          opt.value = archivo;
          opt.textContent = nombre.replace(/\.kml$/i, "");
          instrumentoSelect.appendChild(opt);
        });

        instrumentoSelect.disabled = false;
      } catch (err) {
        console.warn("Error cargando listado.json:", err);
      }
    }

    // ---------------------------------
    // ZOOM POR INSTRUMENTO
    // ---------------------------------
    async function zoomAlInstrumentoPorExtent(regionCode, archivo) {
      if (!archivo) return;

      const url = `capas/capas_${regionCode}/${archivo}`;

      try {
        const resp = await fetch(url);
        const kmlText = await resp.text();
        const xml = new DOMParser().parseFromString(kmlText, "application/xml");

        const coords = xml.querySelectorAll("coordinates");
        const puntos = [];

        coords.forEach(c => {
          c.textContent.trim().split(/\s+/).forEach(par => {
            const [lon, lat] = par.split(",").map(Number);
            if (!isNaN(lat) && !isNaN(lon)) puntos.push([lat, lon]);
          });
        });

        const bounds = L.latLngBounds(puntos);
        map.fitBounds(bounds, { padding: [30, 30] });

      } catch (err) {
        console.warn("No se pudo leer KML:", url);
      }
    }

    // ---------------------------------
    // EVENTOS
    // ---------------------------------
    regionSelect.addEventListener("change", async () => {
      const code = regionSelect.value;
      cargarInstrumentos(code);

      // Leer centro/zoom desde regiones.json
      const resp = await fetch("capas/regiones.json");
      const regiones = await resp.json();
      const r = regiones.find(x => x.codigo_ine === code);

      if (r) map.setView(r.centro, r.zoom);
    });

    instrumentoSelect.addEventListener("change", () => {
      zoomAlInstrumentoPorExtent(regionSelect.value, instrumentoSelect.value);
    });

    // ---------------------------------
    // CLICK EN MAPA → info.html
    // ---------------------------------
    map.on("click", (e) => {
      const regionCode = regionSelect.value || "03";

      const url = new URL("info.html", window.location.href);
      url.searchParams.set("lat", e.latlng.lat);
      url.searchParams.set("lon", e.latlng.lng);
      url.searchParams.set("region", regionCode);

      window.open(url.toString(), "_blank");
    });

    // ---------------------------------
    // INICIALIZACIÓN
    // ---------------------------------
    (async function init() {
      await cargarRegiones();
      cargarInstrumentos("03");
      map.setView([-27.5, -70.5], 7);
    })();
  </script>
</body>
</html>
