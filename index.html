<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>GeoIPT - Mapa de consulta Instrumentos de Planificaci√≥n Territorial</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, Helvetica, Arial, sans-serif;
      background: #0b1120;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #020617;
      border-bottom: 1px solid #111827;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 1000;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-title {
      font-size: 15px;
      font-weight: 600;
    }

    .brand-subtitle {
      font-size: 11px;
      color: #9ca3af;
    }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .select-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .select-label {
      font-size: 11px;
      color: #9ca3af;
    }

    select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background: #0f172a;
      color: #e5e7eb;
      border-radius: 999px;
      border: 1px solid #1f2937;
      padding: 6px 30px 6px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    select:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .select-wrapper::after {
      content: "‚ñæ";
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      color: #9ca3af;
      pointer-events: none;
    }

    .hint {
      font-size: 10px;
      color: #6b7280;
    }

    main {
      flex: 1;
      min-height: 0;
    }

    #map {
      width: 100%;
      height: calc(100vh - 64px);
    }

    @media (max-width: 640px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      #map {
        height: calc(100vh - 88px);
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <span class="brand-title">GeoIPT - Mapa de consulta PRC Beta version</span>
      <span class="brand-subtitle">
        Mapa limpio. Clic en cualquier punto para abrir el detalle en una pesta√±a nueva.
      </span>
    </div>

    <div class="toolbar">
      <div class="select-wrapper">
        <span class="select-label">Regi√≥n:</span>
        <select id="region-select">
          <option value="02">02 - Antofagasta</option>
          <option value="03" selected>03 - Atacama</option>
        </select>
      </div>

      <div class="select-wrapper">
        <span class="select-label">Instrumento:</span>
        <select id="instrumento-select" disabled>
          <option value="">‚Äî Selecciona PRC/SCC ‚Äî</option>
        </select>
      </div>

      <div class="hint" id="hint-text">
        Selecciona regi√≥n e instrumento. Luego haz clic en el mapa para abrir el reporte.
      </div>
    </div>
  </header>

  <main>
    <div id="map"></div>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>

  <script>
    // Configuraci√≥n de regiones y archivos listado.json
    const REGIONES = {
      "02": {
        nombre: "Antofagasta",
        listadoUrl: "capas/capas_02/listado.json"
      },
      "03": {
        nombre: "Atacama",
        listadoUrl: "capas/capas_03/listado.json"
      }
    };

    const regionSelect = document.getElementById("region-select");
    const instrumentoSelect = document.getElementById("instrumento-select");
    const hintText = document.getElementById("hint-text");

// üìå Coordenadas de referencia por defecto: Copiap√≥
const DEFAULT_CENTER = L.latLng(-27.3668, -70.3322);
const CITY_ZOOM = 14;   // escala ~1:10.000
const EXACT_ZOOM = 15;  // ubicaci√≥n exacta si disponible

// Mapa inicial ‚Äî parte importante
var map = L.map("map").setView(DEFAULT_CENTER, CITY_ZOOM);

// Capa base OSM
var capaMapa = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap contributors"
  }
).addTo(map);

// Capa satelital (si ya la tienes)
var capaSatelite = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  {
    maxZoom: 19,
    attribution: "Tiles ¬© Esri"
  }
);

// üîç Intentar ubicaci√≥n exacta o aproximada
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const acc = pos.coords.accuracy; // metros

      // Si accuracy < 200 m = ubicaci√≥n exacta
      // Si accuracy > 2000 m = ubicaci√≥n aproximada (IP)
      const zoomElegido = acc < 200 ? EXACT_ZOOM : CITY_ZOOM;

      map.setView([lat, lon], zoomElegido);

      // Marcador si la ubicaci√≥n es precisa
      if (acc < 300) {
        L.circleMarker([lat, lon], {
          radius: 6,
          color: "#2563eb"
        }).addTo(map).bindPopup("Tu ubicaci√≥n");
      }
    },
    (err) => {
      console.log("No se pudo obtener ubicaci√≥n:", err);
      // Fallback a Copiap√≥ 1:10.000
      map.setView(DEFAULT_CENTER, CITY_ZOOM);
    },
    {
      enableHighAccuracy: false,
      timeout: 6000,
      maximumAge: 300000
    }
  );
} else {
  // Si el navegador no soporta geolocalizaci√≥n
  map.setView(DEFAULT_CENTER, CITY_ZOOM);
}


    // Capas base
    var capaMapa = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors"
      }
    );

    var capaSatelite = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      {
        maxZoom: 19,
        attribution: "Imagery ¬© Esri"
      }
    );

    // Preferencia base desde localStorage
    var baseChoice = null;
    try {
      baseChoice = localStorage.getItem("geoipt_baseLayer");
    } catch (e) {
      baseChoice = null;
    }

    if (baseChoice === "satelital") {
      capaSatelite.addTo(map);
    } else {
      capaMapa.addTo(map);
    }

    // Control de capas
    L.control
      .layers(
        {
          Mapa: capaMapa,
          Satelital: capaSatelite
        },
        null,
        { position: "topright" }
      )
      .addTo(map);

    // Guardar preferencia de base
    map.on("baselayerchange", function (e) {
      try {
        if (e.name === "Mapa") {
          localStorage.setItem("geoipt_baseLayer", "mapa");
        } else if (e.name === "Satelital") {
          localStorage.setItem("geoipt_baseLayer", "satelital");
        }
      } catch (err) {
        console.warn("No se pudo guardar la preferencia de mapa base:", err);
      }
    });

    // Cach√© de bounds por regi√≥n+instrumento (zoom solo visual)
    const ZOOM_CACHE = {};

    function formatearNombreInstrumento(nombreArchivo) {
      let base = nombreArchivo.replace(/\.kml$/i, "");
      base = base.replace(/_/g, " ");
      return base;
    }

    async function cargarInstrumentos(regionCodigo) {
      instrumentoSelect.innerHTML =
        '<option value="">‚Äî Selecciona PRC/SCC ‚Äî</option>';
      instrumentoSelect.disabled = true;
      hintText.textContent =
        "Cargando instrumentos para la regi√≥n " + regionCodigo + "...";

      const cfg = REGIONES[regionCodigo];
      if (!cfg) {
        hintText.textContent =
          "Regi√≥n no configurada. Selecciona otra regi√≥n.";
        return;
      }

      try {
        const resp = await fetch(cfg.listadoUrl + "?_=" + Date.now());
        if (!resp.ok) throw new Error("No se pudo leer listado.json");
        const data = await resp.json();
        const lista = data.kml || [];

        if (!lista.length) {
          hintText.textContent =
            "No se encontraron instrumentos en listado.json para " +
            cfg.nombre;
          return;
        }

        lista.forEach((archivo) => {
          const opt = document.createElement("option");
          opt.value = archivo;
          opt.textContent = formatearNombreInstrumento(archivo);
          instrumentoSelect.appendChild(opt);
        });

        instrumentoSelect.disabled = false;
        hintText.textContent =
          "Selecciona regi√≥n e instrumento. Luego haz clic en el mapa para abrir el reporte.";
      } catch (err) {
        console.error(err);
        hintText.textContent =
          "Error al cargar los instrumentos. Revisa la consola del navegador.";
      }
    }
// Lee un KML y devuelve sus bounds como L.LatLngBounds (solo pol√≠gonos)
async function obtenerBoundsDesdeKml(url) {
  try {
    const resp = await fetch(url + "?_=" + Date.now());
    if (!resp.ok) {
      console.warn("No se pudo leer KML para bounds:", url, resp.status);
      return null;
    }
    const kmlText = await resp.text();

    const parser = new DOMParser();
    const xml = parser.parseFromString(kmlText, "application/xml");
    const placemarks = Array.from(xml.getElementsByTagName("Placemark"));

    const coordsGlobal = [];

    placemarks.forEach((pm) => {
      // Polygons directos
      pm.querySelectorAll("Polygon").forEach((poly) => {
        const coordsEl =
          poly.querySelector("outerBoundaryIs coordinates") ||
          poly.querySelector("outerBoundaryIs>LinearRing>coordinates") ||
          poly.querySelector("coordinates");
        if (!coordsEl) return;
        const coordsText = coordsEl.textContent.trim();
        if (!coordsText) return;

        coordsText.split(/\s+/).forEach((pair) => {
          const parts = pair.split(",");
          const lon = parseFloat(parts[0]);
          const lat = parseFloat(parts[1]);
          if (!isNaN(lat) && !isNaN(lon)) {
            coordsGlobal.push(L.latLng(lat, lon));
          }
        });
      });

      // MultiGeometry -> Polygon
      pm.querySelectorAll("MultiGeometry Polygon").forEach((poly) => {
        const coordsEl =
          poly.querySelector("outerBoundaryIs coordinates") ||
          poly.querySelector("outerBoundaryIs>LinearRing>coordinates") ||
          poly.querySelector("coordinates");
        if (!coordsEl) return;
        const coordsText = coordsEl.textContent.trim();
        if (!coordsText) return;

        coordsText.split(/\s+/).forEach((pair) => {
          const parts = pair.split(",");
          const lon = parseFloat(parts[0]);
          const lat = parseFloat(parts[1]);
          if (!isNaN(lat) && !isNaN(lon)) {
            coordsGlobal.push(L.latLng(lat, lon));
          }
        });
      });
    });

    if (!coordsGlobal.length) {
      console.warn("KML sin coordenadas de pol√≠gonos para bounds:", url);
      return null;
    }

    return L.latLngBounds(coordsGlobal);
  } catch (err) {
    console.error("Error leyendo/parsing KML para bounds:", url, err);
    return null;
  }
}


    
    function zoomInstrumento(regionCodigo, archivoKml) {
      if (!archivoKml) return;

      let carpeta = "capas/";
      if (regionCodigo === "02") carpeta = "capas/capas_02/";
      else if (regionCodigo === "03") carpeta = "capas/capas_03/";

      const url = carpeta + encodeURIComponent(archivoKml);

      const cacheKey = regionCodigo + "|" + archivoKml;

      if (ZOOM_CACHE[cacheKey]) {
        map.fitBounds(ZOOM_CACHE[cacheKey], { padding: [20, 20] });
        return;
      }

      try {
        const loader = omnivore.kml(url);

        loader.on("ready", function () {
          try {
            loader.addTo(map);
            if (loader.setStyle) {
              loader.setStyle({ opacity: 0, fillOpacity: 0 });
            }
            const b = loader.getBounds();
            ZOOM_CACHE[cacheKey] = b;
            map.fitBounds(b, { padding: [20, 20] });
          } catch (e) {
            console.warn("No fue posible obtener bounds para", url, e);
          } finally {
            map.removeLayer(loader);
          }
        });

        loader.on("error", function (err) {
          console.warn("Error cargando KML para zoom:", url, err);
        });
      } catch (e) {
        console.warn("Error creando loader KML para", url, e);
      }
    }

    regionSelect.addEventListener("change", function () {
      const cod = this.value;
      cargarInstrumentos(cod);
      instrumentoSelect.value = "";
    });

    instrumentoSelect.addEventListener("change", function () {
      const archivo = this.value;
      if (!archivo) return;
      const codRegion = regionSelect.value || "";
      zoomInstrumento(codRegion, archivo);
    });

    map.on("click", function (e) {
      const lat = e.latlng.lat;
      const lon = e.latlng.lng;
      const region = regionSelect.value || "";
      const instrumento = instrumentoSelect.value || "";

if (!instrumento) {
    hintText.textContent =
      "Nota: No seleccionaste instrumento, pero el an√°lisis se har√° igual sobre todos los PRC/SCC.";
    // NO hay return aqu√≠ ‚Üí se permite continuar
}


      const params = new URLSearchParams({
        lat: lat,
        lon: lon,
        region: region,
        instrumento: instrumento
      });

      const url = "info.html?" + params.toString();
      window.open(url, "_blank");
    });

    // Cargar instrumentos iniciales (03 Atacama)
    cargarInstrumentos(regionSelect.value);
  </script>
</body>
</html>
