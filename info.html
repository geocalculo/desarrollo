<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>GeoIPT - Reporte del punto consultado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, Helvetica, Arial, sans-serif;
      background: #e5e7eb;
      color: #0f172a;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px 8px;
    }

    .container {
      background: #f9fafb;
      max-width: 1100px;
      width: 100%;
      border-radius: 18px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.18);
      padding: 24px 28px 40px 28px;
    }

    header h1 {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 4px;
      color: #020617;
    }

    header p {
      font-size: 0.95rem;
      color: #4b5563;
    }

    .meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 16px;
      margin: 24px 0 16px 0;
      font-size: 0.9rem;
    }

    .meta-block-title {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .meta-block strong {
      font-weight: 600;
      color: #111827;
    }

    h2.section-title {
      font-size: 1.1rem;
      margin: 24px 0 4px 0;
      color: #111827;
    }

    p.section-tip {
      font-size: 0.85rem;
      color: #6b7280;
      margin-bottom: 10px;
    }

    #map {
      width: 100%;
      height: 420px;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid #d1d5db;
    }

    footer {
      margin-top: 24px;
      font-size: 0.8rem;
      color: #9ca3af;
      text-align: right;
    }

    @media (max-width: 768px) {
      body {
        padding: 12px 6px;
      }

      .container {
        padding: 16px 14px 28px 14px;
        border-radius: 14px;
      }

      #map {
        height: 340px;
      }
    }
  </style>
</head>

<body>
  <main class="container">
    <header>
      <h1>GeoIPT - Reporte del punto consultado</h1>
      <p id="subtituloInstrumento">Instrumento</p>
    </header>

    <section class="meta-grid">
      <div class="meta-block">
        <div class="meta-block-title">Coordenadas WGS84</div>
        <div>Lat: <strong id="latWgs84">-</strong></div>
        <div>Lon: <strong id="lonWgs84">-</strong></div>
      </div>

      <div class="meta-block">
        <div class="meta-block-title">Coordenadas UTM (WGS84)</div>
        <div>Este: <strong id="esteUtm">-</strong></div>
        <div>Norte: <strong id="norteUtm">-</strong></div>
        <div>EPSG: <strong>32719</strong></div>
      </div>

      <div class="meta-block">
        <div class="meta-block-title">Región</div>
        <div><strong id="regionNombre">-</strong></div>
      </div>

      <div class="meta-block">
        <div class="meta-block-title">Instrumento(s) consultado(s)</div>
        <div><strong id="instrumentoNombre">-</strong></div>
      </div>
    </section>

    <section>
      <h2 class="section-title">Mapa de referencia</h2>
      <p class="section-tip">
        Tip: puedes hacer clic nuevamente en este mapa para abrir un nuevo reporte sobre un nuevo punto
        (se abrirá en una pestaña adicional).
      </p>
      <div id="map"></div>
    </section>

    <footer>
      GeoIPT · Informe generado automáticamente
    </footer>
  </main>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // ---------------------------
    // Utilidades URL
    // ---------------------------
    function getParam(name) {
      const params = new URLSearchParams(window.location.search);
      const value = params.get(name);
      return value !== null ? value : "";
    }

    // ---------------------------
    // Lectura de parámetros
    // ---------------------------
    const lat = parseFloat(getParam("lat")) || 0;
    const lon = parseFloat(getParam("lon")) || 0;

    const este = getParam("este");
    const norte = getParam("norte");
    const region = getParam("region") || "Región no especificada";
    const instrumento = getParam("instrumento") || "Instrumento no especificado";

    // GeoJSON de la zona (opcional). Debe venir URL-encoded.
    const polyParam = getParam("poly"); // ej: encodeURIComponent(JSON.stringify(geojson))

    // ---------------------------
    // Pinta encabezado
    // ---------------------------
    document.getElementById("latWgs84").textContent = lat.toFixed(6);
    document.getElementById("lonWgs84").textContent = lon.toFixed(6);

    if (este) document.getElementById("esteUtm").textContent = este;
    if (norte) document.getElementById("norteUtm").textContent = norte;

    document.getElementById("regionNombre").textContent = region;
    document.getElementById("instrumentoNombre").textContent = instrumento;
    document.getElementById("subtituloInstrumento").textContent = instrumento;

    // ---------------------------
    // Mapa Leaflet
    // ---------------------------
    const map = L.map("map", {
      center: [lat, lon],
      zoom: 18,
      scrollWheelZoom: true,
    });

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 20,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>',
    }).addTo(map);

    // Punto consultado (círculo)
    const marker = L.circleMarker([lat, lon], {
      radius: 6,
      color: "#111827",
      weight: 2,
      fillColor: "#ffffff",
      fillOpacity: 1,
    }).addTo(map);

    // ---------------------------
    // Polígono de la zona (GeoJSON)
    // ---------------------------
    let zonaLayer = null;
    if (polyParam) {
      try {
        // polyParam debe venir URL-encoded
        const decoded = decodeURIComponent(polyParam);
        const geojson = JSON.parse(decoded);

        zonaLayer = L.geoJSON(geojson, {
          style: {
            color: "#2563eb",      // borde azul
            weight: 2,
            fillColor: "#60a5fa",  // relleno azul claro
            fillOpacity: 0.25
          }
        }).addTo(map);

        // Ajusta el mapa para que se vean polígono + punto
        const bounds = zonaLayer.getBounds().extend([lat, lon]);
        map.fitBounds(bounds.pad(0.2));
      } catch (err) {
        console.error("Error al interpretar el GeoJSON de la zona:", err);
      }
    }

    // ---------------------------
    // Click en el mapa = nuevo reporte
    // ---------------------------
    map.on("click", function (e) {
      const newLat = e.latlng.lat;
      const newLon = e.latlng.lng;

      // Aquí solo reenviamos lat/lon. Si quieres reenviar también el polígono,
      // tendrás que recalcularlo desde index.html para el nuevo punto.
      const url =
        "info.html?lat=" +
        newLat +
        "&lon=" +
        newLon +
        "&region=" +
        encodeURIComponent(region) +
        "&instrumento=" +
        encodeURIComponent(instrumento);

      window.open(url, "_blank");
    });
  </script>
</body>
</html>
