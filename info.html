<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>GeoIPT - Reporte del punto consultado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin
  />

  <!-- Estilos del reporte -->
  <link rel="stylesheet" href="css/info.css" />
</head>
<body>
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner" aria-label="Cargando reporte..."></div>
  </div>

  <div class="page">
    <div id="report-wrapper">
      <!-- Botón Home (solo pantalla) -->
      <div class="top-bar no-print">
        <button id="btn-home" type="button" class="home-button">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path
              d="M4 11L12 4l8 7v8a1 1 0 0 1-1 1h-4v-5H9v5H5a1 1 0 0 1-1-1v-8Z"
              stroke="currentColor"
              stroke-width="1.7"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          Home
        </button>
      </div>

      <header>
        <h1>GeoIPT - Reporte del punto consultado</h1>
        <div class="coords-row">
          <div class="coords-block">
            <strong>Coordenadas WGS84</strong>
            <span>Lat: <span id="lat-display">-</span></span>
            <span>Lon: <span id="lon-display">-</span></span>
          </div>
          <div class="coords-block">
            <strong>Coordenadas UTM 19S (EPSG:32719)</strong>
            <span>Este: <span id="utm-e-display">-</span></span>
            <span>Norte: <span id="utm-n-display">-</span></span>
          </div>
          <div class="coords-block">
            <strong>Región</strong>
            <span id="region-display">-</span>
          </div>
          <div class="coords-block">
            <strong>Instrumento(s) consultado(s)</strong>
            <span id="instrumento-display">-</span>
          </div>
        </div>
      </header>

      <section>
        <h2>Mapa de referencia</h2>
        <p class="tip">
          Tip: puedes hacer clic nuevamente en este mapa para abrir un nuevo reporte sobre un nuevo punto (se abrirá en una pestaña adicional).
        </p>

        <!-- contenedor para mapa + mira de rifle -->
        <div style="position: relative;">
          <div id="map"></div>

          <!-- Mira de rifle (solo pantalla) -->
          <button
            id="btn-geolocate"
            type="button"
            class="no-print"
            aria-label="Ubicar mi posición"
            title="Ubicar mi posición"
            style="
              position:absolute;
              right:16px;
              bottom:16px;
              width:44px;
              height:44px;
              border-radius:999px;
              border:1px solid #d1d5db;
              background:#ffffffdd;
              display:flex;
              align-items:center;
              justify-content:center;
              box-shadow:0 1px 3px rgba(15,23,42,0.25);
              cursor:pointer;
            "
          >
            <svg
              width="22"
              height="22"
              viewBox="0 0 24 24"
              fill="none"
              stroke="#111827"
              stroke-width="1.8"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="12" cy="12" r="3"></circle>
              <line x1="12" y1="2" x2="12" y2="5"></line>
              <line x1="12" y1="19" x2="12" y2="22"></line>
              <line x1="2" y1="12" x2="5" y2="12"></line>
              <line x1="19" y1="12" x2="22" y2="12"></line>
            </svg>
          </button>
        </div>
      </section>

      <section class="section">
        <h2>Consulta PRC / SCC (punto sobre polígonos de toda la región)</h2>
        <p>
          Evaluación del punto sobre todos los polígonos de los instrumentos PRC/SCC de la región seleccionada.
          El combo del mapa principal se usa solo para zoom óptico; aquí se revisan
          <strong>todos los KML declarados en el listado.json de la región</strong>, filtrando previamente solo
          aquellos cuya extensión intersecta el área visible del mapa de referencia.
        </p>
        <div id="resultado-prc" style="margin-top:0.5rem; font-size:0.95rem;"></div>
        <ul id="lista-coincidencias" class="coincidencias"></ul>

        <h3 id="titulo-atributos" style="margin-top: 1.5rem;">
          Detalle de atributos del/los polígono(s)
        </h3>
        <p id="instrumento-atributos" class="tip"></p>
        <div id="detalle-atributos-prc"></div>
      </section>

      <div class="nota-origen-wrapper">
        <div class="nota-titulo" id="nota-toggle">
          <br />
          <span class="icono" id="nota-icono">+</span>
          Nota sobre el origen de la información
        </div>

        <div class="nota-contenido" id="nota-contenido">
          <p>
            Las capas utilizadas en este reporte corresponden a instrumentos de planificación territorial
            publicados oficialmente por el Ministerio de Vivienda y Urbanismo (MINVU) y otros organismos del Estado de Chile.
            La información mostrada por el presente visor se basa en archivos en formato KML descargados desde la
            Infraestructura de Datos Espaciales del MINVU (IDE MINVU).
          </p>

          <p>
            Los archivos oficiales, actualizados y disponibles para descarga pública, pueden ser revisados directamente en:
            <a href="https://ide.minvu.cl/pages/descargas" target="_blank" rel="noopener">
              https://ide.minvu.cl/pages/descargas
            </a>.
          </p>

          <p>
            Este reporte es referencial y no reemplaza certificaciones emitidas por organismos competentes.
          </p>
        </div>
      </div>

      <div class="actions-row no-print">
        <button id="btn-descargar-kml" type="button" class="action-button">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path
              d="M12 3v9m0 0 3-3m-3 3-3-3M5 18h14M6 21h12"
              stroke="currentColor"
              stroke-width="1.7"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          Descargar KML
        </button>

        <button id="btn-print" type="button" class="action-button">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path
              d="M7 9V4h10v5M6 18H5a2 2 0 0 1-2-2v-4a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-1M8 18h8v3H8v-3Z"
              stroke="currentColor"
              stroke-width="1.7"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          Imprimir reporte
        </button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin
  ></script>

  <script src="js/utm.js"></script>

  <!-- tokml para exportar GeoJSON a KML -->
  <script src="https://unpkg.com/tokml@0.4.0/tokml.js"></script>

  <!-- Lógica del reporte -->
  <script src="js/info.js"></script>
</body>
</html>
