<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>GeoIPT - Reporte del punto consultado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, Helvetica, Arial, sans-serif;
      background: #e5e7eb;
      color: #111827;
      min-height: 100vh;
      padding: 16px;
      display: flex;
      justify-content: center;
    }

    .page {
      width: 100%;
      max-width: 900px;
      background: #f9fafb;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.2);
      padding: 24px;
    }

    h1 {
      font-size: 22px;
      margin-bottom: 8px;
    }

    .coords {
      font-size: 13px;
      margin-bottom: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px 24px;
    }

    .coords span {
      font-weight: 500;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin: 18px 0 8px;
    }

    .section-sub {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 10px;
    }

    #map-ref {
      width: 100%;
      height: 320px;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 16px;
    }

    .result {
      font-size: 14px;
      margin-top: 8px;
    }

    .result strong {
      font-weight: 600;
    }

    .result.ok {
      color: #166534;
    }

    .result.none {
      color: #b91c1c;
    }

    .result-list {
      margin-top: 8px;
      font-size: 13px;
      padding-left: 18px;
    }

    .footer-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 24px;
      gap: 8px;
      flex-wrap: wrap;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 13px;
      cursor: pointer;
      background: #111827;
      color: #f9fafb;
    }

    button:hover {
      background: #020617;
    }

    @media (max-width: 640px) {
      .page {
        padding: 16px;
        border-radius: 12px;
      }
    }

    /* Ajustes para impresión (Descargar PDF) */
    @media print {
      body {
        background: #ffffff;
        padding: 0;
      }
      .page {
        max-width: none;
        box-shadow: none;
        border-radius: 0;
      }
      .footer-actions {
        display: none;
      }
      @page {
        margin: 10mm;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>GeoIPT - Reporte del punto consultado</h1>

    <div class="coords" id="coords-block">
      <!-- aquí se rellenan las coordenadas -->
    </div>

    <div>
      <div class="section-title">Mapa de referencia</div>
      <div class="section-sub">
        Tip: puedes hacer clic nuevamente en este mapa para abrir un nuevo reporte
        sobre un nuevo punto (se abrirá en una pestaña adicional).
      </div>
      <div id="map-ref"></div>
    </div>

    <div>
      <div class="section-title">
        Consulta PRC / SCC (punto sobre polígonos de toda la región)
      </div>
      <div class="section-sub">
        Evaluación del punto sobre todos los polígonos de los instrumentos PRC/SCC
        de la región seleccionada. El combo del mapa principal se usa solo para zoom
        óptico; aquí se revisan <strong>todos los KML declarados en el listado.json de la región</strong>.
      </div>
      <div id="resultado-poligono" class="result">
        Cargando información de zonificación PRC/SCC de la región...
      </div>
      <ul id="lista-coincidencias" class="result-list"></ul>
    </div>

    <div class="footer-actions">
      <button type="button" onclick="window.print()">Descargar PDF</button>
    </div>
  </div>

  <!-- JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

  <script>
    // Configuración de regiones (coincidir con index.html)
    const REGIONES = {
      "02": {
        nombre: "Antofagasta",
        listadoUrl: "capas/capas_02/listado.json",
        carpeta: "capas/capas_02/"
      },
      "03": {
        nombre: "Atacama",
        listadoUrl: "capas/capas_03/listado.json",
        carpeta: "capas/capas_03/"
      }
    };

    // Leer parámetros de la URL
    const params = new URLSearchParams(window.location.search);
    const lat = parseFloat(params.get("lat"));
    const lon = parseFloat(params.get("lon"));
    const region = params.get("region") || "";
    const instrumentoSeleccionado = params.get("instrumento") || "";

    const coordsBlock = document.getElementById("coords-block");
    const resultadoPoligono = document.getElementById("resultado-poligono");
    const listaCoincidencias = document.getElementById("lista-coincidencias");

    // Mostrar coordenadas y datos básicos
    coordsBlock.innerHTML = `
      <div>
        <span>Coordenadas WGS84</span><br />
        Lat: ${isFinite(lat) ? lat.toFixed(6) : "-"} &nbsp;&nbsp;
        Lon: ${isFinite(lon) ? lon.toFixed(6) : "-"}
      </div>
      <div>
        <span>Región</span><br />
        ${region || "-"} ${REGIONES[region] ? " - " + REGIONES[region].nombre : ""}
      </div>
      <div>
        <span>Instrumento seleccionado para zoom</span><br />
        ${instrumentoSeleccionado || "— (no condiciona la evaluación)"}
      </div>
    `;

    // Mapa de referencia
    const mapRef = L.map("map-ref").setView(
      [isFinite(lat) ? lat : -27.36, isFinite(lon) ? lon : -70.31],
      17
    );

    const capaBase = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors"
      }
    ).addTo(mapRef);

    const capaSatelital = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      {
        maxZoom: 19,
        attribution: "Imagery © Esri"
      }
    );

    L.control.layers(
      { "Mapa": capaBase, "Satelital": capaSatelital },
      null,
      { position: "topright" }
    ).addTo(mapRef);

    // Marker del punto consultado
    if (isFinite(lat) && isFinite(lon)) {
      const marker = L.marker([lat, lon]).addTo(mapRef);
      marker.bindPopup(
        `Punto consultado<br>Lat: ${lat.toFixed(6)}<br>Lon: ${lon.toFixed(6)}`
      ).openPopup();
    }

    // Permitir clic en el mapa para nuevo reporte
    mapRef.on("click", function (e) {
      const newLat = e.latlng.lat;
      const newLon = e.latlng.lng;

      const newParams = new URLSearchParams({
        lat: newLat,
        lon: newLon,
        region: region,
        instrumento: instrumentoSeleccionado
      });
      window.open("info.html?" + newParams.toString(), "_blank");
    });

    // Grupo de capas para los polígonos que hacen match
    const matchGroup = L.featureGroup().addTo(mapRef);

    // Función auxiliar: envolver omnivore.kml en una Promise
    function evaluarKmlEnPunto(kmlUrl, nombreArchivo, punto) {
      return new Promise((resolve) => {
        let loader;
        try {
          loader = omnivore.kml(kmlUrl);
        } catch (err) {
          console.warn("Error creando loader KML:", kmlUrl, err);
          resolve(null);
          return;
        }

        loader.on("ready", function () {
          try {
            const geojson = loader.toGeoJSON();
            let featureMatch = null;

            turf.flattenEach(geojson, function (feature) {
              if (featureMatch) return;
              // Pequeño buffer en grados para cubrir bordes
              const buffered = turf.buffer(feature, 0.00001, { units: "degrees" });
              if (turf.booleanPointInPolygon(punto, buffered)) {
                featureMatch = feature;
              }
            });

            if (featureMatch) {
              const layer = L.geoJSON(featureMatch, {
                style: {
                  color: "#2563eb",
                  weight: 2,
                  fillColor: "#60a5fa",
                  fillOpacity: 0.3
                }
              }).addTo(matchGroup);

              resolve({
                archivo: nombreArchivo,
                feature: featureMatch,
                bounds: layer.getBounds()
              });
            } else {
              resolve(null);
            }
          } catch (err) {
            console.error("Error evaluando punto en", kmlUrl, err);
            resolve(null);
          } finally {
            try {
              mapRef.removeLayer(loader);
            } catch (e) {}
          }
        });

        loader.on("error", function (err) {
          console.warn("Error cargando KML:", kmlUrl, err);
          resolve(null);
        });

        loader.addTo(mapRef); // dispara la carga
      });
    }

    // Buscar coincidencias en TODOS los KML de la región
    async function buscarCoincidenciasEnRegion() {
      if (!REGIONES[region]) {
        resultadoPoligono.textContent =
          "La región indicada no está configurada en el sistema.";
        resultadoPoligono.className = "result none";
        return;
      }

      const cfg = REGIONES[region];

      try {
        const resp = await fetch(cfg.listadoUrl + "?_=" + Date.now());
        if (!resp.ok) throw new Error("No se pudo leer listado.json");
        const data = await resp.json();
        const lista = data.kml || [];

        if (!lista.length) {
          resultadoPoligono.textContent =
            "No se encontraron instrumentos PRC/SCC en el listado de la región.";
          resultadoPoligono.className = "result none";
          return;
        }

        const punto = turf.point([lon, lat]);
        const coincidencias = [];

        for (const archivo of lista) {
          const kmlUrl = cfg.carpeta + archivo;
          const res = await evaluarKmlEnPunto(kmlUrl, archivo, punto);
          if (res) {
            coincidencias.push(res);
          }
        }

        if (coincidencias.length) {
          resultadoPoligono.innerHTML =
            "<strong>Resultado:</strong> El punto consultado " +
            "<strong>se encuentra dentro de uno o más polígonos</strong> " +
            "de los instrumentos PRC/SCC de la región.";
          resultadoPoligono.className = "result ok";

          listaCoincidencias.innerHTML = "";
          coincidencias.forEach((c) => {
            const li = document.createElement("li");
            li.textContent = "Coincidencia en archivo: " + c.archivo;
            listaCoincidencias.appendChild(li);
          });

          try {
            mapRef.fitBounds(matchGroup.getBounds(), { padding: [20, 20] });
          } catch (e) {}
        } else {
          resultadoPoligono.innerHTML =
            "<strong>Resultado:</strong> El punto consultado " +
            "<strong>no se encuentra dentro de ningún polígono</strong> " +
            "de los instrumentos PRC/SCC cargados para esta región.";
          resultadoPoligono.className = "result none";
          listaCoincidencias.innerHTML = "";
        }
      } catch (err) {
        console.error(err);
        resultadoPoligono.textContent =
          "Ocurrió un error al evaluar el punto en los instrumentos PRC/SCC de la región.";
        resultadoPoligono.className = "result none";
      }
    }

    // Disparar búsqueda de coincidencias
    if (isFinite(lat) && isFinite(lon)) {
      buscarCoincidenciasEnRegion();
    } else {
      resultadoPoligono.textContent =
        "No se recibieron coordenadas válidas para evaluar el punto.";
      resultadoPoligono.className = "result none";
    }
  </script>
</body>
</html>
