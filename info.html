<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>GeoIPT - Reporte del punto consultado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <!-- Proj4 para convertir a UTM -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.2/proj4.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, Helvetica, Arial, sans-serif;
      background: #e5e7eb;
      color: #0f172a;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px 8px;
    }

    .card {
      width: 1100px;
      max-width: 100%;
      background: #ffffff;
      border-radius: 16px;
      padding: 24px 24px 32px;
      box-shadow: 0 8px 30px rgba(15, 23, 42, 0.18);
    }

    h1 {
      font-size: 1.6rem;
      margin-bottom: 4px;
      color: #0f172a;
    }

    h2 {
      font-size: 1.2rem;
      margin: 18px 0 10px;
      color: #0f172a;
    }

    h3 {
      font-size: 1rem;
      margin: 16px 0 8px;
      color: #0f172a;
    }

    .subtitulo {
      font-size: 0.9rem;
      color: #4b5563;
      margin-bottom: 18px;
    }

    .grid-header {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 16px;
      font-size: 0.85rem;
    }

    .grid-header h4 {
      font-size: 0.8rem;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 4px;
      text-transform: uppercase;
    }

    .grid-header div span.label {
      font-weight: 600;
    }

    #map {
      height: 420px;
      width: 100%;
      margin: 12px 0 4px;
      border-radius: 12px;
      border: 1px solid #cbd5e1;
    }

    .tip {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 6px;
    }

    .texto {
      font-size: 0.88rem;
      line-height: 1.4;
      margin-bottom: 4px;
    }

    .texto strong { font-weight: 600; }

    .resultado-ok {
      color: #16a34a;
      font-weight: 600;
    }

    ul {
      margin: 4px 0 10px 18px;
      font-size: 0.86rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.86rem;
    }

    table th {
      background: #f1f5f9;
      text-align: left;
      padding: 6px 8px;
      border-bottom: 2px solid #cbd5e1;
      font-weight: 600;
    }

    table td {
      padding: 6px 8px;
      border-bottom: 1px solid #e2e8f0;
    }

    .nota {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 10px;
    }

    .adjuntos {
      margin-top: 10px;
      font-size: 0.86rem;
    }

    .adjuntos a {
      color: #2563eb;
      text-decoration: none;
    }

    .adjuntos a:hover { text-decoration: underline; }

    .btn-volver {
      display: inline-block;
      margin-top: 18px;
      padding: 7px 16px;
      background: #0f172a;
      color: #ffffff;
      border-radius: 999px;
      font-size: 0.86rem;
      text-decoration: none;
    }

    .msg-error {
      color: #dc2626;
      background: #fee2e2;
      border: 1px solid #fecaca;
      border-radius: 8px;
      padding: 12px;
      font-size: 0.86rem;
      margin-top: 12px;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>GeoIPT - Reporte del punto consultado</h1>
    <p class="subtitulo" id="subtitulo-instrumento"></p>

    <div id="mensaje"></div>

    <div id="contenido" style="display:none;">

      <!-- Encabezado con coordenadas / región / instrumento -->
      <div class="grid-header">
        <div>
          <h4>Coordenadas WGS84</h4>
          <div><span class="label">Lat:</span> <span id="wgs-lat"></span></div>
          <div><span class="label">Lon:</span> <span id="wgs-lon"></span></div>
        </div>
        <div>
          <h4>Coordenadas UTM (WGS84)</h4>
          <div><span class="label">Este:</span> <span id="utm-e"></span></div>
          <div><span class="label">Norte:</span> <span id="utm-n"></span></div>
          <div><span class="label">EPSG:</span> <span id="utm-epsg"></span></div>
        </div>
        <div>
          <h4>Región</h4>
          <div><span id="region-texto"></span></div>
        </div>
        <div>
          <h4>Instrumento(s) consultado(s)</h4>
          <div id="instrumentos-texto"></div>
        </div>
      </div>

      <h2>Mapa de referencia</h2>
      <p class="tip">
        Tip: puedes hacer clic nuevamente en este mapa para abrir un nuevo reporte sobre un nuevo punto
        (se abrirá en una pestaña adicional).
      </p>
      <div id="map"></div>

      <!-- Lista de vértices al pinchar el polígono -->
      <div id="vertices-poligono" style="margin-top:10px; font-size:0.85rem; color:#111827;"></div>

      <h2>Consulta PRC / SCC (punto sobre polígonos del área visible)</h2>
      <p class="texto">
        Evaluación del punto sobre los polígonos de los instrumentos PRC/SCC detectados por el BBOX
        en el área visible. El mapa principal se usa solo para zoom óptico; aquí se revisan
        <strong>solo los KML que intersectan el frame actual</strong>.
      </p>
      <p class="texto resultado-ok" id="texto-resultado"></p>
      <ul id="lista-coincidencias"></ul>

      <h2 id="titulo-detalle-poligono"></h2>
      <table id="tabla-zona"></table>
      <p class="nota">
        Nota: los atributos corresponden al polígono PRC/SCC que contiene el punto consultado,
        según los campos declarados en el archivo KML de origen.
      </p>

      <h3>Instrumentos en pantalla</h3>
      <table id="tabla-lista">
        <thead>
          <tr>
            <th>Instrumento</th>
            <th>Tipo</th>
            <th>Comuna</th>
            <th>Match BBOX</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="adjuntos">
        <strong>Documentos adjuntos:</strong>
        <ul>
          <li>
            <a href="#" id="link-kml">
              Descargar KML de la zona consultada
            </a>
          </li>
          <li>
            <a href="#" id="link-json-zona">
              Descargar atributos de la zona (JSON)
            </a>
          </li>
        </ul>
      </div>

      <a href="index.html" class="btn-volver">Volver al mapa</a>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ================================
    // 1. Recuperar datos desde localStorage
    // ================================
    function cargarDatosGeoipt() {
      try {
        const raw = localStorage.getItem("geoipt_reporte_actual");
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (e) {
        console.error("Error leyendo geoipt_reporte_actual", e);
        return null;
      }
    }

    const data = cargarDatosGeoipt();
    const mensaje = document.getElementById("mensaje");
    const contenido = document.getElementById("contenido");

    if (!data) {
      mensaje.innerHTML = `
        <div class="msg-error">
          No se encontraron datos de reporte activos.<br/>
          Por favor, vuelva al mapa principal y seleccione un punto sobre una zona urbana.
        </div>
      `;
    } else {
      contenido.style.display = "block";

      const { click, instrumento, zona, tabla } = data;
      const lat = click.lat;
      const lon = click.lng;

      // ================================
      // 2. Subtítulo, región, instrumento
      // ================================
      document.getElementById("subtitulo-instrumento").textContent =
        instrumento.nombre || "";

      document.getElementById("region-texto").textContent =
        instrumento.regionNombre || (zona && zona.REG) || "Región no especificada";

      document.getElementById("instrumentos-texto").textContent =
        instrumento.nombre || instrumento.archivo || "(sin nombre)";

      // ================================
      // 3. WGS84
      // ================================
      document.getElementById("wgs-lat").textContent = lat.toFixed(6);
      document.getElementById("wgs-lon").textContent = lon.toFixed(6);

      // ================================
      // 4. Cálculo de UTM (zona automática)
      // ================================
      let utmZone = Math.floor((lon + 180) / 6) + 1;
      if (utmZone < 1) utmZone = 1;
      if (utmZone > 60) utmZone = 60;

      const epsg = 32700 + utmZone; // hemisferio sur
      const utmDef = `+proj=utm +zone=${utmZone} +south +datum=WGS84 +units=m +no_defs`;

      let este = "";
      let norte = "";
      try {
        const res = proj4("EPSG:4326", utmDef, [lon, lat]);
        este = res[0].toFixed(3);
        norte = res[1].toFixed(3);
      } catch (e) {
        console.error("Error en transformación UTM", e);
      }

      document.getElementById("utm-e").textContent = este;
      document.getElementById("utm-n").textContent = norte;
      document.getElementById("utm-epsg").textContent = `EPSG:${epsg}`;

      // ================================
      // 5. Mapa de referencia
      // ================================
      const map = L.map("map").setView([lat, lon], 17);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 20
      }).addTo(map);

      // Punto consultado
      L.circleMarker([lat, lon], {
        radius: 7,
        weight: 3,
        color: "#0f172a",
        fillColor: "#ffffff",
        fillOpacity: 0.9
      }).addTo(map);

      // ================================
      // 5b. Dibujar polígono de la zona (azul semitransparente)
      //     y mostrar vértices al hacer click sobre él
      // ================================
      (function dibujarPoligonoZona() {
        if (!zona) return;

        let geom = null;

        // Caso 1: zona.geometry = objeto GeoJSON geometry
        if (zona.geometry && zona.geometry.type) {
          geom = zona.geometry;
        }
        // Caso 2: zona.geojson = Feature o FeatureCollection
        else if (zona.geojson) {
          if (zona.geojson.type === "Feature") {
            geom = zona.geojson.geometry;
          } else if (
            zona.geojson.type === "FeatureCollection" &&
            zona.geojson.features &&
            zona.geojson.features.length > 0
          ) {
            geom = zona.geojson.features[0].geometry;
          }
        }
        // Caso 3: zona.coords = array de [lon, lat]
        else if (Array.isArray(zona.coords) && zona.coords.length > 2) {
          const ring = zona.coords.map(function (par) {
            return [par[0], par[1]]; // [lon, lat]
          });
          const first = ring[0];
          const last = ring[ring.length - 1];
          if (first[0] !== last[0] || first[1] !== last[1]) {
            ring.push([first[0], first[1]]);
          }
          geom = { type: "Polygon", coordinates: [ring] };
        }

        if (!geom) return;

        try {
          const capaZona = L.geoJSON(geom, {
            style: {
              color: "#2563eb",     // borde azul
              weight: 2,
              fillColor: "#3b82f6", // relleno azul
              fillOpacity: 0.30     // semitransparente
            }
          }).addTo(map);

          const bounds = capaZona.getBounds().extend([lat, lon]);
          map.fitBounds(bounds.pad(0.15));

          // Mostrar vértices al hacer click sobre el polígono
          const contenedorVertices = document.getElementById("vertices-poligono");

          capaZona.on("click", function (e) {
            // Evitar que el click llegue al mapa (para que NO abra nuevo index.html)
            L.DomEvent.stop(e);

            let coords = [];

            if (geom.type === "Polygon") {
              coords = geom.coordinates[0]; // primer anillo
            } else if (geom.type === "MultiPolygon") {
              if (
                Array.isArray(geom.coordinates) &&
                geom.coordinates.length > 0 &&
                Array.isArray(geom.coordinates[0]) &&
                geom.coordinates[0].length > 0
              ) {
                coords = geom.coordinates[0][0];
              }
            }

            if (!coords || !coords.length) return;

            const items = coords.map(function (par, idx) {
              const lonV = Number(par[0]) || 0;
              const latV = Number(par[1]) || 0;
              return `<li>${idx + 1}. Lon: ${lonV.toFixed(6)} – Lat: ${latV.toFixed(6)}</li>`;
            }).join("");

            contenedorVertices.innerHTML = `
              <h3 style="margin:10px 0 4px; font-size:0.95rem;">Vértices del polígono seleccionado</h3>
              <ol style="margin-left:18px;">
                ${items}
              </ol>
            `;
          });
        } catch (e) {
          console.error("Error dibujando polígono de zona:", e);
        }
      })();

      // ================================
      // 5c. Nueva consulta desde overview
      //     Cada click en el mapa (fuera del polígono) abre index.html?lat=..&lon=..
      // ================================
      map.on("click", function (e) {
        const newLat = e.latlng.lat.toFixed(6);
        const newLon = e.latlng.lng.toFixed(6);
        const url = `index.html?lat=${newLat}&lon=${newLon}`;
        window.open(url, "_blank");
      });

      // ================================
      // 6. Resultado de la consulta
      // ================================
      const textoResultado = document.getElementById("texto-resultado");
      textoResultado.textContent =
        "Resultado: el punto consultado se encuentra dentro de al menos un polígono PRC/SCC.";

      const listaCoincidencias = document.getElementById("lista-coincidencias");
      listaCoincidencias.innerHTML = `
        <li>Coincidencia en archivo: <strong>${instrumento.archivo}</strong></li>
      `;

      // ================================
      // 7. Detalle de atributos de la zona
      // ================================
      document.getElementById("titulo-detalle-poligono").textContent =
        `Detalle de atributos del/los polígono(s) – ${instrumento.archivo}`;

      const tablaZona = document.getElementById("tabla-zona");
      const filasZona = Object.entries(zona)
        .filter(([k, _]) => k !== "geometry" && k !== "geojson" && k !== "coords")
        .map(([k, v]) => `
          <tr>
            <th style="width: 180px;">${k}</th>
            <td>${v}</td>
          </tr>
        `).join("");

      tablaZona.innerHTML = `<tbody>${filasZona}</tbody>`;

      // ================================
      // 8. Tabla de instrumentos en pantalla
      // ================================
      const cuerpoLista = document.querySelector("#tabla-lista tbody");
      cuerpoLista.innerHTML = (tabla || []).map(i => `
        <tr>
          <td>${i.nombre || ""}</td>
          <td>${i.tipo || ""}</td>
          <td>${i.comuna || ""}</td>
          <td>${i.contienePuntoBBOX ? "✔" : ""}</td>
        </tr>
      `).join("");

      // ================================
      // 9. Documentos adjuntos
      //      - JSON ya existía
      //      - KML AHORA solo del polígono azul
      // ================================

      // Helper para escapar texto XML
      function escapeXml(str) {
        return String(str || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&apos;");
      }

      function construirKmlZona(inst, zonaObj) {
        if (!zonaObj || !zonaObj.geometry) return null;
        const geom = zonaObj.geometry;

        let ring = [];
        if (geom.type === "Polygon" && Array.isArray(geom.coordinates) && geom.coordinates.length > 0) {
          ring = geom.coordinates[0];
        } else if (
          geom.type === "MultiPolygon" &&
          Array.isArray(geom.coordinates) &&
          geom.coordinates.length > 0 &&
          geom.coordinates[0].length > 0
        ) {
          ring = geom.coordinates[0][0];
        }

        if (!ring || ring.length < 3) return null;

        const coordsStr = ring
          .map(par => `${par[0]},${par[1]},0`)
          .join(" ");

        const nombreInstrumento = inst.nombre || inst.archivo || "Zona GeoIPT";
        const nombreZona =
          zonaObj.NOM || zonaObj.ZONA || zonaObj.NOMBRE_PM || "Zona consultada";

        const attrsXml = Object.entries(zonaObj)
          .filter(([k]) => k !== "geometry" && k !== "geojson" && k !== "coords")
          .map(([k, v]) =>
            `        <Data name="${escapeXml(k)}"><value>${escapeXml(v)}</value></Data>`
          )
          .join("\n");

        return `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>${escapeXml(nombreInstrumento)}</name>
    <Style id="geoipt_poly">
      <LineStyle>
        <color>ffeb6325</color>
        <width>2</width>
      </LineStyle>
      <PolyStyle>
        <color>66f6823b</color>
      </PolyStyle>
    </Style>
    <Placemark>
      <name>${escapeXml(nombreZona)}</name>
      <styleUrl>#geoipt_poly</styleUrl>
      <ExtendedData>
${attrsXml}
      </ExtendedData>
      <Polygon>
        <outerBoundaryIs>
          <LinearRing>
            <coordinates>
              ${coordsStr}
            </coordinates>
          </LinearRing>
        </outerBoundaryIs>
      </Polygon>
    </Placemark>
  </Document>
</kml>`;
      }

      const linkKml = document.getElementById("link-kml");
      linkKml.addEventListener("click", function (ev) {
        ev.preventDefault();
        const kmlStr = construirKmlZona(instrumento, zona);
        if (!kmlStr) {
          alert("No se pudo construir el KML de la zona consultada.");
          return;
        }
        const blob = new Blob(
          [kmlStr],
          { type: "application/vnd.google-earth.kml+xml" }
        );
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        const baseName = (instrumento.archivo || "zona").replace(/\.kml$/i, "");
        a.download = `geoipt_zona_${baseName}.kml`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

      const linkJsonZona = document.getElementById("link-json-zona");
      linkJsonZona.addEventListener("click", function (ev) {
        ev.preventDefault();
        const blob = new Blob(
          [JSON.stringify(zona, null, 2)],
          { type: "application/json" }
        );
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `geoipt_zona_${instrumento.archivo.replace(/\.kml$/i, "")}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });
    }
  </script>
</body>
</html>
