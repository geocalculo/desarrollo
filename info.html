<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>GeoIPT - Reporte del punto consultado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, Helvetica, Arial, sans-serif;
      background: #e5e7eb;
      color: #0f172a;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    h1, h2, h3 {
      margin-bottom: 10px;
      color: #0f172a;
    }

    #contenedor {
      width: 900px;
      max-width: 100%;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    #map {
      height: 300px;
      width: 100%;
      margin: 12px 0;
      border-radius: 10px;
      border: 1px solid #cbd5e1;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    table th {
      background: #f1f5f9;
      text-align: left;
      padding: 8px;
      border-bottom: 2px solid #cbd5e1;
    }

    table td {
      padding: 8px;
      border-bottom: 1px solid #e2e8f0;
    }

    .btn {
      padding: 8px 16px;
      background: #0f172a;
      color: white;
      border-radius: 6px;
      text-decoration: none;
      display: inline-block;
      margin-top: 20px;
    }

    .msg-error {
      color: #dc2626;
      background: #fee2e2;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>

<div id="contenedor">
  <h1>Reporte GeoIPT</h1>

  <div id="mensaje"></div>

  <div id="area-reporte" style="display:none;">

    <h2 id="titulo-instrumento"></h2>

    <div id="map"></div>

    <h3>Zona donde cae el punto</h3>
    <table id="tabla-zona"></table>

    <h3>Instrumento</h3>
    <table id="tabla-instrumento"></table>

    <h3>Instrumentos en pantalla</h3>
    <table id="tabla-lista"></table>

    <a href="index.html" class="btn">Volver al mapa</a>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ================================
// 1. Recuperar datos del motor BBOX (bbox_test)
// ================================
function cargarDatosGeoipt() {
  try {
    const raw = localStorage.getItem("geoipt_reporte_actual");
    if (!raw) return null;
    return JSON.parse(raw);
  } catch (e) {
    console.error("Error leyendo localStorage", e);
    return null;
  }
}

const data = cargarDatosGeoipt();
const msg  = document.getElementById("mensaje");
const area = document.getElementById("area-reporte");

if (!data) {
  msg.innerHTML = `
    <div class="msg-error">
      No existe una consulta activa.  
      Por favor, vuelva al mapa y seleccione un punto válido.
    </div>
  `;
} else {
  area.style.display = "block";

  const { click, instrumento, zona, tabla } = data;

  // ================================
  // 2. Título del instrumento
  // ================================
  document.getElementById("titulo-instrumento").textContent =
    instrumento.nombre || "Instrumento sin nombre";

  // ================================
  // 3. Mapa centrado en el punto
  // ================================
  const map = L.map("map").setView([click.lat, click.lng], 16);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 20
  }).addTo(map);

  L.circleMarker([click.lat, click.lng], {
    radius: 6,
    weight: 3,
    color: "#0f172a"
  }).addTo(map);

  // ================================
  // 4. Tabla de zona PRC
  // ================================
  const tablaZona = document.getElementById("tabla-zona");
  tablaZona.innerHTML = Object.entries(zona)
    .map(([k,v]) => `<tr><th>${k}</th><td>${v}</td></tr>`)
    .join("");

  // ================================
  // 5. Tabla de instrumento (metadatos)
  // ================================
  const tablaInstr = document.getElementById("tabla-instrumento");
  tablaInstr.innerHTML = `
    <tr><th>Nombre</th><td>${instrumento.nombre}</td></tr>
    <tr><th>Tipo</th><td>${instrumento.tipo}</td></tr>
    <tr><th>Comuna</th><td>${instrumento.comuna}</td></tr>
    <tr><th>Región</th><td>${instrumento.regionNombre}</td></tr>
    <tr><th>Archivo</th><td>${instrumento.archivo}</td></tr>
  `;

  // ================================
  // 6. Tabla de instrumentos en pantalla
  // ================================
  const tablaLista = document.getElementById("tabla-lista");

  tablaLista.innerHTML = `
    <tr>
      <th>Instrumento</th>
      <th>Tipo</th>
      <th>Comuna</th>
      <th>Match</th>
    </tr>
    ${
      tabla.map(i => `
        <tr>
          <td>${i.nombre}</td>
          <td>${i.tipo}</td>
          <td>${i.comuna}</td>
          <td>${i.contienePuntoBBOX ? "✔" : ""}</td>
        </tr>
      `).join("")
    }
  `;
}
</script>

</body>
</html>
